@model ChatSessionViewModel
@{
    ViewData["Title"] = "Chat with " + Model.HistoricalFigure.Name;
}

<section class="py-5 bg-dark text-light">
    <div class="container">
        <div id="chat-conversation">
            <h4 class="mb-4 text-uppercase">
                Chat with @Model.HistoricalFigure.Name</h4>

            <div class="spacer-half"></div>

            <!-- Messages Loop -->
            @foreach (var msg in Model.Messages)
            {
                if (msg.Sender == "User")
                {
                    <!-- My Message -->
                    <div class="d-flex justify-content-end mb-4">
                        <div class="comment-info text-end">
                            <span class="c_name text-light">You</span>
                            <span class="c_date id-color">@msg.SentAt.ToString()</span>
                            <div class="clearfix"></div>
                            <div class="comment bg-primary text-white p-3 rounded-3 mt-2 d-inline-block">
                                @msg.MessageText
                            </div>
                        </div>
                        <div class="avatar ms-2">
                            <img src="~/assets/images/testimonial/1.webp" class="w-70px rounded-circle" alt="">
                        </div>
                    </div>
                }
                else
                {
                    <!-- AI Reply -->
                    <div class="d-flex mb-4">
                        <div class="avatar me-2">
                            <img src="@Model.HistoricalFigure.ImageUrl" class="w-70px rounded-circle" alt="">
                        </div>
                        <div class="comment-info">
                            <span class="c_name text-light">@Model.HistoricalFigure.Name</span>
                            <span class="c_date id-color">@msg.SentAt.ToString()</span>
                            <div class="clearfix"></div>
                            <div class="comment bg-secondary text-white p-3 rounded-3 mt-2 d-inline-block">
                                @msg.MessageText
                            </div>
                        </div>
                    </div>
                }
            }

            <div class="spacer-single"></div>

            <!-- Send Message Form -->
            <div id="comment-form-wrapper" class="mt-4">
                <h4>Send a Message</h4>
                <div class="comment_form_holder">
                    <form id="sendMessageForm" class="form-border">
                        <label>Message <span class="req">*</span></label>
                        <textarea id="messageInput" class="form-control mb-4" rows="3" placeholder="Type your message..."></textarea>
                        <button type="submit" class="btn-main fx-slide">
                            <span>Send</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        const form = document.getElementById('sendMessageForm');
        const messageInput = document.getElementById('messageInput');
        const chatContainer = document.getElementById('chat-conversation');
        const sessionId = '@Model.Id';

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text) return;

            await fetch(`/Chat/SendMessage?sessionId=${sessionId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messageText: text })
            });

            // أضف الرسالة مباشرة للواجهة
            chatContainer.insertAdjacentHTML('beforeend', `
                <div class="d-flex justify-content-end mb-4">
                    <div class="comment-info text-end">
                        <span class="c_name text-light">You</span>
                        <span class="c_date id-color">Just now</span>
                        <div class="clearfix"></div>
                        <div class="comment bg-primary text-white p-3 rounded-3 mt-2 d-inline-block">
                            ${text}
                        </div>
                    </div>
                    <div class="avatar ms-2">
                        <img src="~/assets/images/testimonial/1.webp" class="w-70px rounded-circle" alt="">
                    </div>
                </div>
            `);

            messageInput.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });
    </script>
}